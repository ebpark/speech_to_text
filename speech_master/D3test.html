<!DOCTYPE html>
<html>
  <head>
      <title> Break and Form</title>
    <meta charset='utf-8'>
    <style>
        .axis path,
        .axis line {
        fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }
        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        #start_button {
			display: block;
			border: none;
			color: white;
			background: black;
			padding: 5px 20;
			font-size: 20px;
			line-height: 30px;
			margin: 20px auto;
		}
    </style>        
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/p5.js"></script>
    
    
  </head>
  <body>
        <input type="button" id="start_button" value="Start" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
    <script>
// Initialize Firebase
    var config = {
        apiKey: "AIzaSyB--tihtbFHV93UANT0zBZOV0T_W2MWoKw",
        authDomain: "human-learning-session-1.firebaseapp.com",
        databaseURL: "https://human-learning-session-1.firebaseio.com",
        storageBucket: "",
    };
	firebase.initializeApp(config);
	var database = firebase.database();

	$('#enter').keyup(function(){
		console.log($(this).val())
		database.ref('session_1').set($(this).val());
	})


	database.ref('session_1').on('value', function(snapshot) {
		initial_transcript = snapshot.val()+' ';
		$('#disp').html(snapshot.val())
		if( $('#enter').val() == 'loading') {
			$('#enter').html(snapshot.val())
		}

	});

	database.ref('session_1_interim').on('value', function(snapshot) {
		$('#interim_enter').html(snapshot.val())
		$('#interim').html(snapshot.val())

	});

	//Speech Transcription

	var check_transcript = '';
	// var doublecheck_transcript = '';

	var recognition = new webkitSpeechRecognition();
	recognition.continuous = true;
	recognition.interimResults = true;


	// initiated text recognition
	recognition.onstart = function() {
	    recognizing = true;
		ignore_onend = false;
	}

	//

	recognition.onresult = function(event) {
		var interim_transcript = '';


		for (var i = event.resultIndex; i < event.results.length; ++i) {
			if (event.results[i].isFinal) {
	        	final_transcript += event.results[i][0].transcript + " ";
			    console.log(i);
	      	} else {
	        	interim_transcript += event.results[i][0].transcript +" ";
	      	}
	    }
	    final_transcript = capitalize(final_transcript);
        database.ref('session_1').set(linebreak(final_transcript));
        
        var index1 = recognizeForm1(linebreak(final_transcript));
        var index2 = recognizeForm2(linebreak(final_transcript));
        if (index1 >= 0 && index2 >=0) {
            form = index1 > index2 ? true : false;
        } else if (index1 >=0) {
            form = true;
        } else {
            form = false;
        }
    }

	recognition.onerror = function(event) { }

	recognition.onend = function() {
		if (!ignore_onend) {
			recognition.start();
		}
	}


	// formatting the text
	var two_line = /\n\n/g;
	var one_line = /\n/g;
	function linebreak(s) {
	  return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
	}

	var first_char = /\S/;
	function capitalize(s) {
	  return s.replace(first_char, function(m) { return m.toUpperCase(); });
	}

    var button = document.getElementById('start_button');
    button.addEventListener("click", startButton)
	// trigger the transcription
	function startButton() {
        console.log("Started");
		final_transcript = initial_transcript;
		recognition.start();
		$("#start_button").css('background','#ff0000');
		button.removeEventListener("click", startButton);
        button.addEventListener("click", stopButton);
        button.value = "Stop";
        form = false;
	}

	// stop the transcription
	function stopButton() {
        console.log("Stopped");
		ignore_onend = true;
		recognition.stop();
		$("#start_button").css('background','#000000');
		button.removeEventListener("click", stopButton);
        button.addEventListener("click", startButton);
        button.value = "Start";
        form = true;
	}

    var form = true;
    var table;
    var switchDirection;
    
    var circlesX = [];
    var circlesY = [];
    var moveX = [];
    var moveY = [];
    var angleX = [];
    var angleY = [];
    var colorFill = [];

    // Where is the circle
    function preload() {
        //my table is comma separated value "csv"
        //and has a header specifying the columns labels
        table = loadTable('Countries.csv', 'csv', 'header');
    }
    function setup() {
        var x, y;

        createCanvas(1500, 1000);
        // Starts in the middle
        x = width / 2;
        y = height;
        switchDirection = 0;
        for (var r = 0; r < table.getRowCount()-1; r++) {
            circlesX.push(table.getColumn('gdp')[r]/100+150);
            circlesY.push(table.getColumn('whi')[r]*50);
            moveX.push(table.getColumn('gdp')[r]/10000);
            moveY.push(table.getColumn('whi')[r]/10);
            angleX.push(sin(random(-1*PI, PI)));
            angleY.push(sin(random(-1*PI, PI)));
            colorFill.push(color(random(0,255),random(0,255),random(0,255)));
        }
    }


    function draw() {
        background(256,256,256);
        switchDirection++;
        for (var r = 1; r < table.getRowCount(); r++) {
            var x = circlesX[r-1];
            var y = circlesY[r-1];
            stroke(50);
            fill(colorFill[r-1]);
            ellipse(x, y, 20, 20);
            if (!form) {
                if (y > 1000) {
                    y = 1;
                } else if (y < 0) {
                    y = 999;
                }
                if (x > 1500) {
                    x = 1;
                } else if (x < 0) {
                    x = 1499;
                }
                circlesX[r-1] = x + moveX[r-1]*angleX[r-1];
                circlesY[r-1] = y + moveY[r-1]*angleY[r-1];
            } else {
                var xDest = table.getColumn('gdp')[r-1]/100+150;
                var yDest = table.getColumn('whi')[r-1]*50;
                if (x > (xDest-2) && x < (xDest+2))  {
                    if (y > (yDest-2) && y < (yDest+2)) {
                        circlesX[r-1] = xDest;
                        circlesY[r-1] = yDest;
                    }
                } else {
                    circlesX[r-1] = x + 4*calVectorX(xDest,x,yDest,y);
                    circlesY[r-1] = y + 4*calVectorY(xDest,x,yDest,y);
                }
            }
        }
    }

    function calVectorX(destX, originX, destY, originY) {
        var direction = originX > destX ? -1:1;
        var magnitude = Math.sqrt(Math.pow(originX-destX,2)+Math.pow(originY-destY,2));
        return direction*(Math.abs(originX-destX))/magnitude;
    }

    function calVectorY(destX, originX, destY, originY) {
        var direction = originY > destY ? -1:1;
        var magnitude = Math.sqrt(Math.pow(originX-destX,2)+Math.pow(originY-destY,2));
        return direction*(Math.abs(originY-destY))/magnitude;
    }

    function recognizeForm1(text) {
        var index = text.lastIndexOf("gather");
        console.log(index);
        return index;
    }

    function recognizeForm2(text) {
        var index = text.lastIndexOf("break");
        console.log(index);
        return index;
    }
    </script>
  </body>
</html>